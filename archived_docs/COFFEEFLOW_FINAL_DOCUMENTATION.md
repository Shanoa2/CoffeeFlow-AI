# CoffeeFlow-AI 项目完整文档

## 🎯 项目概述

CoffeeFlow-AI 是一个基于 OpenPOM 深度学习模型的智能咖啡风味预测系统。通过结合图神经网络气味预测模型和大语言模型，为用户提供科学的咖啡风味分析。

### 核心功能
- **自然语言输入**：用户用自然语言描述咖啡制作过程
- **智能参数提取**：使用 Dify 参数提取器自动识别关键信息
- **分子预测**：基于科研文献预测咖啡中的香味分子
- **气味分析**：通过 OpenPOM API 预测分子气味
- **风味报告**：生成专业的咖啡风味分析报告

## 🏗️ 系统架构

```
┌─────────────────┐
│   用户输入界面   │
└────────┬────────┘
         ↓
┌─────────────────┐     ┌──────────────────┐
│  Dify Workflow  │────→│  科研文献知识库   │
└────────┬────────┘     └──────────────────┘
         ↓
┌─────────────────┐     ┌──────────────────┐
│  LLM 分析引擎   │────→│  OpenPOM API    │
└────────┬────────┘     │ (capi.shanoa.net)│
         ↓              └──────────────────┘
┌─────────────────┐
│   风味报告输出   │
└─────────────────┘
```

## 📦 技术栈

- **深度学习框架**：DeepChem, DGL, PyTorch
- **工作流平台**：Dify
- **API服务**：Flask + OpenPOM
- **知识管理**：非结构化文献检索
- **部署环境**：CPU服务器

## 🔧 Dify 工作流配置

### 工作流节点结构

```
节点1(开始) → 节点2(参数提取器) → 节点3/4(知识检索) → 节点5(知识综合) 
    → 节点6(分子预测) → 节点7(SMILES提取) → 节点8(HTTP请求) → 节点9(风味分析)
```

### 节点详细配置

#### 节点1：开始节点
- **类型**：开始节点
- **输入变量**：`user_description`（用户的咖啡制作描述）

#### 节点2：参数提取器节点 ✨
- **类型**：参数提取器
- **提取参数**：
  - `coffee_origin`：咖啡产地（字符串）
  - `roast_level`：烘焙程度（选项：浅烘/中烘/深烘）
  - `roast_time`：烘焙时间（数字，5-25分钟）
  - `roast_temp`：烘焙温度（数字，160-250℃）
  - `process_method`：处理方法（选项：水洗/日晒/蜜处理/湿刨法）
  - `brewing_method`：冲煮方式（选项：手冲/意式/法压壶/虹吸壶）

#### 节点3：咖啡化学知识检索
- **类型**：知识检索
- **知识库**：coffee_research_database
- **检索Query**：
```
咖啡化学成分研究：{{#node-2.coffee_origin#}}产地咖啡豆在{{#node-2.roast_level#}}烘焙条件下的分子组成、香味化合物、{{#node-2.process_method#}}处理方法对分子结构的影响、美拉德反应产物、挥发性有机化合物VOCs
```

#### 节点4：烘焙化学知识检索
- **类型**：知识检索
- **知识库**：coffee_research_database
- **检索Query**：
```
咖啡烘焙化学反应：{{#node-2.roast_temp#}}度{{#node-2.roast_time#}}分钟烘焙条件下的化学变化、美拉德反应、焦糖化反应、挥发性化合物生成、分子结构变化、SMILES分子式
```

#### 节点5：知识综合分析
- **类型**：LLM节点
- **功能**：从科研文献中提取分子信息
- **输出**：包含SMILES分子式的JSON格式

#### 节点6：最终分子预测
- **类型**：LLM节点
- **功能**：选择5-8个最具代表性的分子

#### 节点7：SMILES提取节点
- **类型**：LLM节点
- **启用结构化输出**：
```json
{
  "type": "object",
  "properties": {
    "smiles_list": {
      "type": "array",
      "items": {"type": "string"},
      "description": "SMILES分子式数组"
    }
  },
  "required": ["smiles_list"]
}
```

#### 节点8：OpenPOM API调用
- **类型**：HTTP请求节点
- **方法**：POST
- **URL**：`https://capi.shanoa.net/predict_batch`
- **Headers**：
```
Content-Type: application/json
```
- **Body**：
```json
{
  "smiles_list": {{#node-7.structured_output.smiles_list#}},
  "threshold": 0.3,
  "top_k": 5
}
```

#### 节点9：风味分析报告
- **类型**：LLM节点
- **功能**：生成专业的咖啡风味分析报告
- **引用变量**：
  - 用户描述：`{{user_description}}`
  - 咖啡参数：`{{#node-2.coffee_origin#}}`等
  - 气味预测：`{{#node-8.body.predictions#}}`

## 📊 知识库配置

### 内容类型
- 咖啡化学研究论文
- 烘焙化学反应研究
- 挥发性有机化合物分析报告
- 不同产地咖啡成分对比研究
- 处理方法对化学成分影响的研究

### 检索配置
- **分段方式**：智能分段
- **嵌入模型**：text-embedding-3-large
- **检索模式**：混合检索
- **Top-K**：8-10
- **Score阈值**：0.6

## 🚀 部署说明

### OpenPOM API 服务
- **地址**：https://capi.shanoa.net
- **端点**：
  - 健康检查：`GET /`
  - 单分子预测：`POST /predict`
  - 批量预测：`POST /predict_batch`

### 本地服务部署
```bash
# 进入部署目录
cd /root/CoffeeFlow-AI/deploy_package

# 启动服务
./start_server.sh
```

## 🧪 测试用例

### 测试1：埃塞俄比亚浅烘咖啡
**输入**：
```
我刚买了一包埃塞俄比亚耶加雪菲的豆子，是水洗处理的。今天早上浅烘了大概10分钟，温度控制在180度左右。想用V60手冲，请帮我分析一下风味。
```

**预期输出特征**：
- 花香、果香突出
- 酸度明亮
- 茶感清晰

### 测试2：巴西深烘咖啡
**输入**：
```
巴西豆子，日晒处理的，深度烘焙了18分钟，温度到了220度，豆子都出油了。准备拿来做意式浓缩，会是什么味道？
```

**预期输出特征**：
- 巧克力、坚果风味
- 苦味明显
- 醇厚度高

## ✅ 关键优化点

### 1. 参数提取器优势
- ✅ **更稳定**：输出格式固定，避免JSON解析错误
- ✅ **更快速**：专门优化的提取算法
- ✅ **更经济**：比LLM节点消耗更少资源
- ✅ **类型安全**：自动类型验证和范围检查

### 2. 结构化输出
- 使用Dify原生的结构化输出功能
- 保证SMILES数组格式正确
- 方便后续节点直接引用

### 3. HTTP请求优化
- 正确引用结构化输出的路径
- 使用标准的JSON格式
- 设置合适的超时时间

## 📝 维护说明

### 常见问题

1. **参数提取失败**
   - 检查参数提取器的配置
   - 确认默认值设置合理

2. **API调用失败**
   - 验证API服务状态
   - 检查网络连接
   - 确认请求格式正确

3. **知识检索不准确**
   - 优化检索Query
   - 调整Top-K和Score阈值
   - 扩充知识库内容

### 更新维护

1. **知识库更新**
   - 定期添加最新研究文献
   - 优化文档标签和分类

2. **模型优化**
   - 收集用户反馈
   - 调整提示词策略
   - 优化工作流节点

## 🔄 版本历史

- **v2.0** (2024-06-22)
  - 使用参数提取器替代LLM信息提取
  - 优化HTTP请求节点配置
  - 改进结构化输出处理

- **v1.0** (2024-06-21)
  - 初始版本发布
  - 基础工作流实现

---

**项目团队**：CoffeeFlow-AI Team  
**最后更新**：2024-06-22