# CoffeeFlow-AI: Dify工作流开发指南

## 🎯 项目概述

CoffeeFlow-AI是一个基于OpenPOM模型的智能咖啡风味预测系统。通过结合深度学习气味预测模型和大语言模型，为用户提供个性化的咖啡风味分析。

### 核心流程
1. **用户输入** → 咖啡制作参数（产地、烘焙程度等）
2. **知识检索** → 查询咖啡分子数据库
3. **分子预测** → 生成咖啡中的分子组成
4. **气味预测** → 调用OpenPOM API预测各分子气味
5. **风味分析** → 综合分析生成咖啡风味报告

## 🏗️ 系统架构

```
┌─────────────────┐
│   用户输入界面   │
└────────┬────────┘
         ↓
┌─────────────────┐     ┌──────────────────┐
│  Dify Workflow  │────→│  咖啡分子数据库   │
└────────┬────────┘     └──────────────────┘
         ↓
┌─────────────────┐     ┌──────────────────┐
│  LLM 分析节点   │────→│  OpenPOM API    │
└────────┬────────┘     └──────────────────┘
         ↓
┌─────────────────┐
│   风味报告输出   │
└─────────────────┘
```

## 📦 前置准备

### 1. OpenPOM API服务
确保OpenPOM API已正常运行：
```bash
# 检查API状态
curl https://capi.shanoa.net/

# 预期返回
{
    "status": "healthy",
    "service": "Odor Prediction API",
    "models_loaded": 10
}
```

### 2. 咖啡分子数据库
准备包含以下信息的知识库：
- 不同产地咖啡的特征分子
- 烘焙程度对分子组成的影响
- 处理方法对香味分子的影响
- 常见咖啡分子的SMILES表示

## 🔧 Dify工作流配置

### Step 1: 创建新工作流
1. 登录Dify平台
2. 创建新应用 → 选择"工作流"类型
3. 命名为"CoffeeFlow-AI咖啡风味预测"

### Step 2: 工作流节点设计

#### 节点1: 开始节点（用户输入）
**类型**: 开始节点  
**变量设置**:
```yaml
变量名:
  - user_description: 用户的咖啡制作描述（文本输入）
```

**输入示例**:
- "我用埃塞俄比亚的豆子，浅烘焙了10分钟，温度大概180度，水洗处理的，想做手冲"
- "巴西豆深烘18分钟，日晒处理，准备做意式咖啡"
- "刚买了哥伦比亚的蜜处理豆子，中度烘焙，想知道适合什么风味"

#### 节点2: 参数提取器节点
**类型**: 参数提取器  
**连接**: 节点1（开始节点）

**配置参数**:

**参数1: coffee_origin（咖啡产地）**
```
参数名: coffee_origin
参数类型: 字符串
描述: 咖啡豆的产地，如埃塞俄比亚、巴西、哥伦比亚等
是否必需: 是
默认值: 未知
```

**参数2: roast_level（烘焙程度）**
```
参数名: roast_level
参数类型: 选项
描述: 咖啡的烘焙程度
是否必需: 是
选项: 浅烘、中烘、深烘
默认值: 中烘
```

**参数3: roast_time（烘焙时间）**
```
参数名: roast_time
参数类型: 数字
描述: 烘焙时间，单位分钟
是否必需: 否
最小值: 5
最大值: 25
默认值: 12
```

**参数4: roast_temp（烘焙温度）**
```
参数名: roast_temp
参数类型: 数字
描述: 烘焙温度，单位摄氏度
是否必需: 否
最小值: 160
最大值: 250
默认值: 200
```

**参数5: process_method（处理方法）**
```
参数名: process_method
参数类型: 选项
描述: 咖啡豆的处理方法
是否必需: 否
选项: 水洗、日晒、蜜处理、湿刨法
默认值: 水洗
```

**参数6: brewing_method（冲煮方式）**
```
参数名: brewing_method
参数类型: 选项
描述: 咖啡的冲煮方式
是否必需: 否
选项: 手冲、意式、法压壶、虹吸壶
默认值: 手冲
```

**提取指令配置**:
```
从用户的咖啡制作描述中提取以下信息：

1. 产地：识别咖啡豆来源，如"埃塞俄比亚"、"耶加雪菲"
2. 烘焙程度：识别"浅烘"、"中烘"、"深烘"相关词汇
3. 烘焙时间：提取分钟数，如"10分钟"
4. 烘焙温度：提取温度值，如"180度"、"180℃"
5. 处理方法：识别"水洗"、"日晒"、"蜜处理"等
6. 冲煮方式：识别"手冲"、"V60"、"意式"、"浓缩"等

如果信息不明确，请使用默认值。
```

**参数提取器节点的优势**：
- ✅ **更稳定**：输出格式固定，避免JSON解析错误
- ✅ **更快速**：专门优化的提取算法
- ✅ **更经济**：比LLM节点消耗更少资源
- ✅ **易配置**：可视化参数设置，无需复杂提示词
- ✅ **类型安全**：自动类型验证和范围检查

**后续节点引用方式**：
```
{{#node-2.coffee_origin#}}  // 直接引用提取的参数
{{#node-2.roast_level#}}
{{#node-2.roast_temp#}}
```

#### 节点3: 咖啡化学知识检索节点
**类型**: 知识检索  
**配置**:
- 知识库: coffee_research_database（包含论文、研究资料）
- 检索模式: 混合检索
- Top K: 8-10（增加检索数量以获得更全面的信息）
- Score阈值: 0.6（降低阈值以包含更多相关信息）

**检索Query模板**:
```
咖啡化学成分研究：{{#node-2.coffee_origin#}}产地咖啡豆在{{#node-2.roast_level#}}烘焙条件下的分子组成、香味化合物、{{#node-2.process_method#}}处理方法对分子结构的影响、美拉德反应产物、挥发性有机化合物VOCs
```

#### 节点4: 烘焙化学知识检索节点
**类型**: 知识检索  
**配置**:
- 知识库: coffee_research_database
- 检索模式: 语义检索优先
- Top K: 6-8
- Score阈值: 0.6

**检索Query模板**:
```
咖啡烘焙化学反应：{{#node-2.roast_temp#}}度{{#node-2.roast_time#}}分钟烘焙条件下的化学变化、美拉德反应、焦糖化反应、挥发性化合物生成、分子结构变化、SMILES分子式
```

#### 节点5: 知识综合分析节点（LLM节点）
**类型**: LLM节点  
**模型**: GPT-4 或 Claude  
**系统提示词**:
```
你是一位咖啡化学研究专家，擅长从科研文献中提取关键信息并进行知识综合。你需要分析提供的研究资料，提取出与特定咖啡制作条件相关的分子信息。

分析任务：
1. 从检索到的论文和研究资料中识别相关的化学信息
2. 提取具体的分子名称和SMILES结构式
3. 分析不同条件对分子组成的影响
4. 综合多个信息源，得出最可能的分子组成

关键信息提取重点：
- 特定产地咖啡的特征化合物
- 不同烘焙条件下的化学反应产物
- 处理方法对分子结构的影响
- 挥发性有机化合物(VOCs)的种类和含量
- 美拉德反应、焦糖化反应的具体产物

输出要求：
1. 基于文献evidence进行推理，不要凭空猜测
2. 优先选择有明确SMILES表示的分子
3. 注明信息来源的可信度
4. 如果信息不足，明确指出并给出合理假设

输出格式（JSON）：
{
  "molecules": [
    {
      "smiles": "分子SMILES表示",
      "name": "分子名称",
      "percentage": 相对含量估计,
      "source": "生成机理",
      "evidence_level": "高/中/低（基于文献支持程度）",
      "literature_source": "相关文献信息"
    }
  ],
  "knowledge_gaps": ["缺失的关键信息"],
  "confidence_score": 0.8
}
```

**用户提示词模板**:
```
请基于以下科研资料，分析咖啡的分子组成：

咖啡制作参数：
- 产地：{{#node-2.coffee_origin#}}
- 烘焙程度：{{#node-2.roast_level#}}
- 烘焙条件：{{#node-2.roast_temp#}}℃，{{#node-2.roast_time#}}分钟
- 处理方法：{{#node-2.process_method#}}
- 冲煮方式：{{#node-2.brewing_method#}}

咖啡化学成分相关研究：
{{#node-3.result#}}

烘焙化学反应相关研究：
{{#node-4.result#}}

请仔细分析上述文献资料，提取与给定条件最相关的分子信息，并预测这杯咖啡中的主要香味分子组成。请特别注意：
1. 引用具体的研究数据和发现
2. 区分不同烘焙程度和处理方法的影响
3. 优先选择有明确化学结构的化合物
4. 标注信息的可信度和来源
```

#### 节点6: 最终分子预测节点（LLM节点）
**类型**: LLM节点  
**模型**: GPT-4 或 Claude  
**系统提示词**:
```
你是一位咖啡化学专家，需要基于前面的知识综合分析结果，最终确定用于OpenPOM预测的分子列表。

任务要求：
1. 整合知识综合分析的结果
2. 选择最有代表性的5-8个分子进行气味预测
3. 确保所有分子都有有效的SMILES表示
4. 优先选择evidence_level较高的分子
5. 平衡不同化学类别的分子（酯类、醇类、酚类等）

分子选择原则：
- 高可信度的文献支持分子优先
- 具有重要香味贡献的分子优先
- SMILES格式正确且可被OpenPOM识别
- 避免过于复杂或罕见的分子结构

输出格式（JSON）：
{
  "molecules": [
    {
      "smiles": "分子SMILES表示",
      "name": "分子名称",
      "percentage": 相对含量,
      "source": "生成来源",
      "selection_reason": "选择此分子的原因"
    }
  ],
  "total_molecules": 分子总数,
  "prediction_confidence": "整体预测可信度"
}
```

**用户提示词模板**:
```
基于知识综合分析结果，请选择最适合进行气味预测的分子：

知识综合分析结果：
{{#node-5.output#}}

请根据分析结果，选择5-8个最具代表性的分子进行OpenPOM气味预测。选择时请考虑：
1. 文献支持程度（evidence_level）
2. 分子的香味重要性
3. SMILES格式的正确性
4. 分子类别的多样性

输出最终的分子列表，用于下一步的气味预测。
```

#### 节点7: 代码执行节点（调用OpenPOM API）
**类型**: 代码执行  
**语言**: Python  
**代码**:
```python
import json
import requests

def main(molecules_json: str) -> dict:
    """
    调用OpenPOM API批量预测分子气味
    """
    try:
        # 解析分子数据
        molecules_data = json.loads(molecules_json)
        molecules = molecules_data.get("molecules", [])
        
        # 提取SMILES列表
        smiles_list = [mol["smiles"] for mol in molecules]
        
        # 调用OpenPOM API
        api_url = "https://capi.shanoa.net/predict_batch"
        payload = {
            "smiles_list": smiles_list,
            "threshold": 0.3,
            "top_k": 5
        }
        
        response = requests.post(api_url, json=payload, timeout=30)
        response.raise_for_status()
        
        # 处理响应
        predictions = response.json()["predictions"]
        
        # 合并原始数据和预测结果
        for i, mol in enumerate(molecules):
            mol["odor_predictions"] = predictions[i]["odors"]
        
        return {
            "molecules_with_odors": molecules,
            "status": "success"
        }
        
    except Exception as e:
        return {
            "error": str(e),
            "status": "failed"
        }
```

**输入变量**: `{{#node-6.output#}}`  
**输出变量**: `odor_predictions`

#### 节点8: 风味分析节点（LLM节点）
**类型**: LLM节点  
**模型**: GPT-4 或 Claude  
**系统提示词**:
```
你是一位专业的咖啡品鉴师和风味分析专家。基于分子气味预测结果，为用户生成详细的咖啡风味分析报告。

分析要点：
1. 主要风味特征描述
2. 风味层次分析（前调、中调、后调）
3. 风味平衡性评价
4. 与产地特色的关联
5. 冲煮建议

输出风格：
- 专业但易懂
- 使用咖啡品鉴术语
- 提供具体的感官描述
- 给出实用的品饮建议
```

**用户提示词模板**:
```
用户的原始描述：
{{user_description}}

提取的咖啡信息：
- 产地：{{#node-2.coffee_origin#}}
- 烘焙程度：{{#node-2.roast_level#}}
- 处理方法：{{#node-2.process_method#}}
- 冲煮方式：{{#node-2.brewing_method#}}

分子气味分析结果：
{{#node-7.odor_predictions#}}

文献支持信息：
{{#node-5.output#}}

请生成这杯咖啡的完整风味分析报告。请注意结合文献中的科学依据，使报告更加专业可信。
```

#### 节点9: 结束节点（输出整理）
**类型**: 结束节点  
**输出变量**:
- `flavor_report`: 完整的风味分析报告
- `main_flavors`: 主要风味标签列表
- `brewing_suggestions`: 冲煮建议
- `scientific_basis`: 科学依据摘要

## 📊 知识库准备（针对非结构化数据）

### 咖啡研究文献知识库
**内容类型**：
- 咖啡化学研究论文
- 烘焙化学反应研究
- 挥发性有机化合物分析报告
- 不同产地咖啡成分对比研究
- 处理方法对化学成分影响的研究

### 知识库优化策略

#### 1. 文档预处理
```
建议的文档结构：
- 按研究主题分类存储
- 提取关键摘要和结论
- 标注重要的SMILES分子式
- 添加产地、烘焙条件等标签
```

#### 2. 检索配置优化
- **分段策略**：按段落分段，保持上下文完整性
- **嵌入模型**：使用科学文献优化的embedding模型
- **检索模式**：混合检索（向量检索 + 关键词检索）
- **分段长度**：800-1200字符（保证完整的研究描述）

#### 3. 关键词标签系统
为每个文档添加结构化标签：
```
标签示例：
- 产地：[埃塞俄比亚, 巴西, 哥伦比亚, ...]
- 烘焙程度：[浅烘, 中烘, 深烘]
- 化学类别：[酯类, 醇类, 酚类, 醛类, ...]
- 研究方法：[GC-MS, HPLC, 感官分析, ...]
- 关键分子：[咖啡因, 绿原酸, 糠醛, ...]
```

### 数据库导入步骤
1. 在Dify中创建新知识库："咖啡化学研究数据库"
2. 按主题分批上传文献（PDF、DOC格式）
3. 设置检索增强配置：
   - 分段方式：智能分段
   - 嵌入模型：text-embedding-3-large
   - 检索模式：混合检索
   - 召回设置：Top-K=8-10

## 🧪 测试用例

### 测试1: 埃塞俄比亚浅烘咖啡
**用户输入**:
```
"我刚买了一包埃塞俄比亚耶加雪菲的豆子，是水洗处理的。今天早上浅烘了大概10分钟，温度控制在180度左右。想用V60手冲，请帮我分析一下风味。"
```

**预期输出特征**:
- 花香、果香突出
- 酸度明亮
- 茶感清晰

### 测试2: 巴西深烘咖啡
**用户输入**:
```
"巴西豆子，日晒处理的，深度烘焙了18分钟，温度到了220度，豆子都出油了。准备拿来做意式浓缩，会是什么味道？"
```

**预期输出特征**:
- 巧克力、坚果风味
- 苦味明显
- 醇厚度高

### 测试3: 用户简单描述
**用户输入**:
```
"哥伦比亚豆子，中烘，想知道风味如何"
```

**参数提取器处理**:
```
coffee_origin: "哥伦比亚"
roast_level: "中烘" 
roast_time: 12        // 使用默认值
roast_temp: 200       // 使用默认值
process_method: "水洗" // 使用默认值
brewing_method: "手冲" // 使用默认值
```

**参数提取器优势体现**:
- ✅ 自动填充缺失参数的默认值
- ✅ 输出格式始终一致
- ✅ 类型安全（数字就是数字，字符串就是字符串）

## 🚀 部署与优化

### 性能优化建议
1. **缓存策略**
   - 对相同参数的查询结果进行缓存
   - 设置合理的缓存过期时间（如24小时）

2. **批处理优化**
   - 收集多个分子后统一调用OpenPOM API
   - 减少API调用次数

3. **并发处理**
   - 知识检索和API调用可并行执行
   - 使用异步节点提高响应速度

### 监控指标
- 工作流执行时间
- API调用成功率
- 用户满意度评分
- 预测准确性（与专业品鉴对比）

## 📝 常见问题

### Q1: OpenPOM API调用超时
**解决方案**:
- 增加timeout参数
- 减少单次预测的分子数量
- 检查服务器资源使用情况

### Q2: 知识库检索结果不准确
**解决方案**:
- 优化知识库内容结构
- 调整检索参数（Top K、Score阈值）
- 使用更精确的检索query

### Q3: 风味描述不够专业
**解决方案**:
- 完善系统提示词
- 提供更多咖啡品鉴术语示例
- 加入few-shot learning示例

## 🔄 迭代改进方向

1. **数据库扩充**
   - 增加更多产地和处理方法
   - 细化烘焙曲线影响
   - 加入季节性变化因素

2. **模型优化**
   - 收集用户反馈优化预测
   - 建立风味-分子关联模型
   - 个性化推荐算法

3. **用户体验**
   - 可视化风味轮展示
   - 多语言支持
   - 风味对比功能

## 📞 技术支持

如遇到问题，请检查：
1. OpenPOM API服务状态
2. Dify工作流日志
3. 知识库索引状态

---

**最后更新**: 2024-06-22  
**维护团队**: CoffeeFlow-AI Team